# 객체지향 쿼리 언어2 - 중급 문법

## 경로 표현식

### 경로 표현식 용어
- 상태 필드: 단순히 값을 저장하기 위한 필드
- 연관 필드: 연관관계를 위한 필

### 경로 표현식 특징
- 상태 필드: 경로 탐색의 끝, 더 이상 탐색할 수 없다.
- 단일 값 연관 경로: 묵시적 내부 조인(inner join) 발생, 더 탐색할 수 있다.
- 컬렉션 값 연관 경로: 묵시적 내부 조인 발생, 더 이상 탐색할 수 없다. (from 절에서 별칭을 얻으면 별칭으로 탐색 가능)
- 묵시적 내부 조인이 발생하는 쿼리 권장 X

### 명시적 조인 & 묵시적 조인
- 명시적 조인: join 키워드 직접 사용함으로써 발생한다.
- 묵시적 조인: 경로 표현식에 의해 묵시적으로 SQL 조인이 발생한다.

<br/>

## 페치 조인 (fetch join)

### 페치 조인
- SQL 조인 종류 X
- 성능 최적화를 위해 JPQL에서 제공한다.
- 연관된 엔티티 또는 컬렉션을 한번에 조회한다.
- join fetch 명령어를 사용한다.

### 컬렉션 페치 조인
- 일대다 관계에서 사용한다.
- 컬렉션 페치 조인을 사용한다.

```
select t from Team t join fetch t.members where t.name = 'teamA'
```

### 페치 조인과 DISTINCT
- 추가로 애플리케이션에서 중복 제거를 시도한다.
- 같은 식별자를 가진 엔티티를 제거한다.

```
select distinct t from Team t join fetch t.members where t.name = 'teamA'
```

### 페치 조인과 일반 조인의 차이
일반 조인을 실행하면 연관된 엔티티를 함께 조인하지 않는다.

### 페치 조인의 특징과 한계
- 페치 조인 대상에는 별칭을 줄 수 없다.
- 둘 이상의 컬렉션은 페치 조인할 수 없다.
- 컬렉션을 페치 조인하면 페이징 API를 사용할 수 없다.

<br/>

## Named 쿼리

```
@NamedQuery(
    name = "Member.findByUsername",
    query = "select m from Member m where m.username = :username")
```

### 정적 쿼리
- 미리 정의해서 이름을 부여해두고 사용한다.
- 정적 쿼리
- 어노테이션, XML에 정의한다.
- 애플리케이션 로딩 시점에 초기화 후 재사용한다.
- 애플리케이션 로딩 시점에 쿼리를 검증한다.

<br/>

## 벌크 연산

### 예제
- 쿼리 한 번으로 여러 테이블 로우를 변경한다. (Entity)
- executeUpdate() 결과는 영향 받은 엔티티 수를 반환한다.
- UPDATE와 DELETE를 지원한다.

### 주의
- 벌크 연산은 영속성 컨텍스트를 무시하고 데이터베이스에 직접 쿼리를 날린다.
- 벌크 연산을 먼저 실행하거나, 연산 수행 후 영속성 컨텍스트를 초기화 해야 한다.
